<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Force Layout Visualization - Author Network</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            display: flex;
            width: 90%;
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .controls {
            flex: 0 0 250px; /* Fixed width for controls */
            padding: 20px;
            border-right: 1px solid #ccc;
        }
        .visualization-area {
            flex-grow: 1;
            padding: 20px;
        }
        h1 {
            color: #333;
            margin-top: 0;
            font-size: 1.5em;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
        }
        .current-value {
            font-weight: normal;
            float: right;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 10px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            z-index: 10;
        }
        /* Style for the SVG elements */
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: pointer;
        }

        /* Legend Styling */
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border: 1px solid #333;
            margin-right: 8px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="controls">
            <h1>Force Layout Controls</h1>

            <div class="control-group">
                <label for="chargeSlider">Force Many Body (Charge): <span id="chargeValue" class="current-value"></span></label>
                <input type="range" id="chargeSlider" min="-1000" max="-10" step="10" value="-300">
            </div>

            <div class="control-group">
                <label for="collideSlider">Force Collide (Radius Factor): <span id="collideValue" class="current-value"></span></label>
                <input type="range" id="collideSlider" min="1.0" max="5.0" step="0.1" value="1.2">
            </div>

            <div class="control-group">
                <label for="linkStrengthSlider">Link Strength: <span id="linkStrengthValue" class="current-value"></span></label>
                <input type="range" id="linkStrengthSlider" min="0.01" max="1.0" step="0.01" value="0.2">
            </div>

            <h2>Affiliation Country Legend</h2>
            <div id="legend">
                </div>
        </div>

        <div class="visualization-area">
            <h1>Author Network Force Directed Graph</h1>
            <svg id="network-viz"></svg>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Set up dimensions
        const margin = {top: 10, right: 10, bottom: 10, left: 10};
        const width = 1000 - margin.left - margin.right; // Adjusted for better viewing
        const height = 800 - margin.top - margin.bottom;

        // Append the SVG object to the visualization area
        const svg = d3.select("#network-viz")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tooltip setup
        const tooltip = d3.select("#tooltip");

        // Load the data
        d3.json("author_network_data.json").then(function(data) {
            const nodes = data.nodes;
            const links = data.links;
            const topCountries = data.top_countries;

            // 2. Hue Channel: Color Scale (Top 10 vs. Other)
            const colorScale = d3.scaleOrdinal()
                .domain([...topCountries, 'Other'])
                .range(d3.schemeCategory10.slice(0, 10).concat(['#A9A9A9'])); // #A9A9A9 is DarkGray

            // Populate Legend
            const legendData = [...topCountries, 'Other'];
            const legend = d3.select("#legend");

            legend.selectAll(".legend-item")
                .data(legendData)
                .enter()
                .append("div")
                .attr("class", "legend-item")
                .html(d => `<div class="legend-color" style="background-color: ${colorScale(d)}"></div> ${d}`);


            // 4. Force Layout Visualization: Node Sizing
            const maxDegree = d3.max(nodes, d => d.degree);
            // d3.scaleSqrt (r range[3, 12])
            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDegree])
                .range([3, 12]);

            // Set up the force simulation
            let simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links)
                    .id(d => d.id)
                    .strength(d => d.weight / d3.max(links, l => l.weight)) // Initial strength based on weight
                )
                .force("charge", d3.forceManyBody().strength(-300)) // Initial charge
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("x", d3.forceX(width / 2).strength(0.01))
                .force("y", d3.forceY(height / 2).strength(0.01))
                .force("collide", d3.forceCollide().radius(d => radiusScale(d.degree) * 1.2)); // Initial collide radius factor 1.2

            // Draw links
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke-width", d => Math.sqrt(d.weight));

            // Draw nodes
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("r", d => radiusScale(d.degree))
                .attr("fill", d => colorScale(d.country))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                )
                .on("mouseover", handleMouseOver) // UI Interaction: Mouse Over
                .on("mouseleave", handleMouseLeave)
                .on("click", handleClick); // UI Interaction: Click

            // Ticking function for simulation update
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // 3. UI Interaction: Mouse Over/Leave
            function handleMouseOver(event, d) {
                // Dim all nodes/links first
                node.transition().duration(200).style("opacity", 0.2);
                link.transition().duration(200).style("opacity", 0.2);

                // Highlight nodes with the same country affiliation
                node.filter(n => n.country === d.country)
                    .transition().duration(200).style("opacity", 1.0);

                // Highlight links connected to the hovered node AND links between highlighted nodes (optional, but good)
                link.filter(l => l.source.id === d.id || l.target.id === d.id)
                    .transition().duration(200).style("opacity", 1.0);
            }

            function handleMouseLeave(event, d) {
                // Return all nodes and links to normal opacity
                node.transition().duration(200).style("opacity", 1.0);
                link.transition().duration(200).style("opacity", 0.6);
            }

            // 3. UI Interaction: Click/Tooltip
            function handleClick(event, d) {
                // Toggle visibility of the tooltip
                const currentOpacity = tooltip.style("opacity");
                if (currentOpacity === "1") {
                    tooltip.transition().duration(200).style("opacity", 0);
                } else {
                    tooltip.html(`
                        <strong>Author:</strong> ${d.id}<br/>
                        <strong>Affiliation:</strong> ${d.country}<br/>
                        <strong>Co-authors:</strong> ${d.degree}
                    `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .transition().duration(200).style("opacity", .9);
                }
            }

            // 4. UI Controls: Update Force Parameters

            const chargeSlider = d3.select("#chargeSlider");
            const collideSlider = d3.select("#collideSlider");
            const linkStrengthSlider = d3.select("#linkStrengthSlider");

            const chargeValue = d3.select("#chargeValue");
            const collideValue = d3.select("#collideValue");
            const linkStrengthValue = d3.select("#linkStrengthValue");

            // Initial value display
            chargeValue.text(chargeSlider.property("value"));
            collideValue.text(collideSlider.property("value"));
            linkStrengthValue.text(linkStrengthSlider.property("value"));

            // Charge control
            chargeSlider.on("input", function() {
                const newCharge = +this.value;
                chargeValue.text(newCharge);
                simulation.force("charge").strength(newCharge);
                simulation.alpha(1).restart(); // Restart simulation with new force
            });

            // Collide control
            collideSlider.on("input", function() {
                const newFactor = +this.value;
                collideValue.text(newFactor.toFixed(1));
                simulation.force("collide").radius(d => radiusScale(d.degree) * newFactor);
                simulation.alpha(1).restart();
            });

            // Link Strength control
            linkStrengthSlider.on("input", function() {
                const newStrength = +this.value;
                linkStrengthValue.text(newStrength.toFixed(2));
                // Set the link strength on the link force
                simulation.force("link").strength(newStrength);
                simulation.alpha(1).restart();
            });


        }).catch(function(error) {
            console.error("Error loading or processing data: ", error);
            svg.append("text")
               .attr("x", width/2)
               .attr("y", height/2)
               .attr("text-anchor", "middle")
               .style("font-size", "16px")
               .text("Error loading data. Make sure 'author_network_data.json' is in the same directory.");
        });

    </script>
</body>
</html>